// services/telegramNotificationService.js
export class TelegramNotificationService {
    constructor(bot) {
        this.messageQueue = [];
        this.isProcessing = false;
        this.sendInterval = 300; // ms
        this.maxRetries = 3;
        this.bot = bot;
    }

    /**
     * Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ
     */
    addToQueue(messageData) {
        this.messageQueue.push({
            ...messageData,
            retryCount: 0,
            addedAt: Date.now(),
        });

        if (!this.isProcessing) {
            this.processQueue();
        }
    }

    /**
     * Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ
     */
    addMultipleToQueue(messages) {
        messages.forEach((message) => {
            this.messageQueue.push({
                ...message,
                retryCount: 0,
                addedAt: Date.now(),
            });
        });

        if (!this.isProcessing) {
            this.processQueue();
        }
    }

    /**
     * ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
     */
    async processQueue() {
        if (this.isProcessing || this.messageQueue.length === 0) {
            return;
        }

        this.isProcessing = true;

        while (this.messageQueue.length > 0) {
            const message = this.messageQueue[0];

            try {
                // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ñ„Ð¾Ñ‚Ð¾ Ð¸Ð»Ð¸ Ð±ÐµÐ·
                if (message.image_url) {
                    await this.sendPhotoMessage(message);
                } else {
                    await this.sendTextMessage(message);
                }

                // Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ - ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð¸Ð· Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
                this.messageQueue.shift();

                // Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¿ÐµÑ€ÐµÐ´ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼
                if (this.messageQueue.length > 0) {
                    await this.delay(this.sendInterval);
                }
            } catch (error) {
                console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:`, error.message);

                message.retryCount++;

                if (message.retryCount >= this.maxRetries) {
                    console.error(`âŒ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð´Ð»Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:`, message);
                    this.messageQueue.shift();
                } else {
                    this.messageQueue.push(this.messageQueue.shift());
                    await this.delay(this.sendInterval * 2);
                }
            }
        }

        this.isProcessing = false;
    }

    /**
     * ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ Ñ„Ð¾Ñ‚Ð¾
     */
    async sendPhotoMessage(messageData) {
        const { chatId, text, image_url, options = {} } = messageData;

        if (!chatId || !text || !image_url) {
            throw new Error('ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹: chatId, text Ð¸Ð»Ð¸ image_url');
        }

        try {
            await this.bot.api.sendPhoto(chatId, image_url, {
                caption: text,
                parse_mode: 'HTML',
                ...options,
            });

            console.log(`âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ñ„Ð¾Ñ‚Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ${chatId}`);
        } catch (error) {
            // Ð•ÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ Ñ„Ð¾Ñ‚Ð¾, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
            if (
                error.description &&
                (error.description.includes('failed to get HTTP URL content') ||
                    error.description.includes('wrong file identifier') ||
                    error.description.includes('unsupported URL protocol'))
            ) {
                console.log('âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ');

                // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ .webp Ð² .jpg
                const convertedUrl = this.convertToWbFormat(image_url);

                if (convertedUrl !== image_url) {
                    try {
                        await this.bot.api.sendPhoto(chatId, convertedUrl, {
                            caption: text,
                            parse_mode: 'HTML',
                            ...options,
                        });
                        console.log(`âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ Ñ„Ð¾Ñ‚Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ${chatId}`);
                        return;
                    } catch (secondError) {
                        console.log('âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ Ñ„Ð¾Ñ‚Ð¾, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ');
                    }
                }

                await this.sendTextMessage(messageData);
                return;
            }

            if (error.description && error.description.includes('Too Many Requests')) {
                console.log('âš ï¸ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ');
                await this.delay(1000);
                throw error;
            }

            if (error.description && error.description.includes('bot was blocked')) {
                console.log(`âŒ Ð‘Ð¾Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ ${chatId}`);
                throw new Error('BOT_BLOCKED');
            }

            throw error;
        }
    }

    convertToWbFormat(url) {
        if (!url) return url;

        // Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ images/big/ Ð½Ð° images/hq/ Ð¸ .jpg Ð½Ð° .webp
        const convertedUrl = url.replace(/images\/big\//i, 'images/hq/').replace(/\.jpg($|\?)/i, '.webp$1');

        // Ð•ÑÐ»Ð¸ URL Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ, Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ð¾
        if (convertedUrl !== url) {
            console.log(`ðŸ”„ ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½ URL: ${url} -> ${convertedUrl}`);
        }

        return convertedUrl;
    }

    /**
     * ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
     */
    async sendTextMessage(messageData) {
        const { chatId, text, options = {} } = messageData;

        if (!chatId || !text) {
            throw new Error('ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹: chatId Ð¸Ð»Ð¸ text');
        }

        try {
            await this.bot.api.sendMessage(chatId, text, {
                parse_mode: 'HTML',
                disable_web_page_preview: true,
                ...options,
            });

            console.log(`âœ… Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ${chatId}`);
        } catch (error) {
            if (error.description && error.description.includes('Too Many Requests')) {
                console.log('âš ï¸ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ');
                await this.delay(1000);
                throw error;
            }

            if (error.description && error.description.includes('bot was blocked')) {
                console.log(`âŒ Ð‘Ð¾Ñ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ ${chatId}`);
                throw new Error('BOT_BLOCKED');
            }

            throw error;
        }
    }

    /**
     * Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
     */
    getQueueStatus() {
        return {
            queueLength: this.messageQueue.length,
            isProcessing: this.isProcessing,
            nextMessage: this.messageQueue[0] || null,
        };
    }

    /**
     * ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
     */
    clearQueue() {
        this.messageQueue = [];
        console.log('ðŸ§¹ ÐžÑ‡ÐµÑ€ÐµÐ´ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ð°');
    }

    /**
     * ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
     */
    getStats() {
        const now = Date.now();
        const recentMessages = this.messageQueue.filter((msg) => now - msg.addedAt < 60000);

        return {
            totalInQueue: this.messageQueue.length,
            recentAdded: recentMessages.length,
            isActive: this.isProcessing,
            sendInterval: this.sendInterval,
        };
    }

    /**
     * Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
     */
    delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
    }
}
